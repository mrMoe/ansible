---

# mariadb

- mysql_db: name={{db_name}} state=present
  when: db_name is defined
  tags: db

- mysql_user: name={{db_name}} password={{db_pass}} priv='{{db_name}}.*:ALL' state=present
  when: db_name is defined
  tags: db

# nginx

- template: src=templates/nginx.conf.j2 dest=/etc/nginx/sites-available/{{domain}}
  notify: restart nginx
  tags: web

- file: path=/etc/nginx/sites-enabled/{{domain}} src=/etc/nginx/sites-available/{{domain}} state=link
  notify: restart nginx
  tags: web

- file: path=/var/www/{{domain}}/html owner=www-data group=www-data mode=u=rwX,g=rX,o=rX recurse=yes
  when: redirect_domain is undefined or not redirect_domain
  tags: web
- shell: rm -rf /var/www/{{domain}}_forwarded_to_* warn=false
  when: redirect_domain is undefined or not redirect_domain
  tags: web

- file: path=/var/www/{{domain}} state=absent
  when: redirect_domain is defined and redirect_domain
  tags: web
- copy: dest=/var/www/{{domain}}_forwarded_to_{{redirect_domain}} content="-"
  when: redirect_domain is defined and redirect_domain
  tags: web

# postifix mailing

## alias domains

- lineinfile: path=/etc/postfix/virtual_alias_maps create=yes line="{{domain}} enabled" state="{{'present' if not mailbox else 'absent'}}"
  notify: restart postfix
  tags: mail
- lineinfile: path=/etc/postfix/virtual_alias_maps create=yes line="@{{domain}} {{mail_forward}}" state="{{'present' if not mailbox else 'absent'}}"
  when: mail_forward is defined
  notify: restart postfix
  tags: mail
- lineinfile: path=/etc/postfix/virtual_mailbox_domains create=yes line="{{domain}} enabled" state="{{'present' if mailbox else 'absent'}}"
  notify: restart postfix
  tags: mail

## mailbox domains

- file: path=/var/vmail/auth.d/{{domain}} owner=doveauth group=doveauth mode=u=rX,g=,o= state="{{'directory' if mailbox else 'absent'}}"
  when: mailbox is defined
  tags: mail
- file: path=/var/vmail/auth.d/{{domain}}/passwd state=touch owner=doveauth group=doveauth mode=u=rX,g=,o=
  when: mailbox is defined and mailbox
  tags: mail
- file: path=/var/vmail/mails/{{domain}} owner=vmail group=vmail mode=u=rwX,g=,o= state="{{'directory' if mailbox else 'absent'}}"
  when: mailbox is defined
  tags: mail

### autoconfig

- file: path=//var/www/{{domain}}/html/.well-known/autoconfig/mail state=directory recurse=yes
  when: mailbox is defined and mailbox
  tags: mail
- template: src=templates/mail.autoconfig.xml.j2 dest=/var/www/{{domain}}/html/.well-known/autoconfig/mail/config-v1.1.xml
  when: mailbox is defined and mailbox
  tags: mail