---
- mysql_db: name={{db_name}} state=present
  when: db_name is defined
  tags: db

- mysql_user: name={{db_name}} password={{db_pass}} priv='{{db_name}}.*:ALL' state=present
  when: db_name is defined
  tags: db

- template: src=templates/nginx.conf.j2 dest=/etc/nginx/sites-available/{{domain}}
  notify: restart nginx
  tags: web

- file: path=/etc/nginx/sites-enabled/{{domain}} src=/etc/nginx/sites-available/{{domain}} state=link
  notify: restart nginx
  tags: web

- file: path=/var/www/{{domain}}/html owner=www-data group=www-data mode=u=rwX,g=rX,o=rX recurse=yes
  tags: web

- lineinfile: path=/etc/postfix/virtual_alias_maps create=yes line="{{domain}} enabled" state="{{'present' if not mailbox else 'absent'}}"
  notify: restart postfix
  tags: mail
- lineinfile: path=/etc/postfix/virtual_alias_maps create=yes line="@{{domain}} {{mail_forward}}" state="{{'present' if not mailbox else 'absent'}}"
  when: mail_forward is defined
  notify: restart postfix
  tags: mail
- lineinfile: path=/etc/postfix/virtual_mailbox_domains create=yes line="{{domain}} enabled" state="{{'present' if mailbox else 'absent'}}"
  notify: restart postfix
  tags: mail

- file: path=/var/vmail/auth.d/{{domain}} owner=doveauth group=doveauth mode=u=rX,g=,o= state="{{'directory' if mailbox else 'absent'}}"
  when: mailbox is defined
  tags: mail
- file: path=/var/vmail/auth.d/{{domain}}/passwd state=touch owner=doveauth group=doveauth mode=u=rX,g=,o=
  when: mailbox is defined and mailbox
  tags: mail
- file: path=/var/vmail/mails/{{domain}} owner=vmail group=vmail mode=u=rwX,g=,o= state="{{'directory' if mailbox else 'absent'}}"
  when: mailbox is defined
  tags: mail

